<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      crossorigin
      href="https://unpkg.com/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      crossorigin
      src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"
    ></script>
    <style>
      .pin-icon {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid m-0 p-0" id="root"></div>
    <script type="text/javascript">
      const { createElement: c, useEffect, useState } = React;

      function sortByPinned(a, b) {
        if (a.pin && !b.pin) return -1;
        if (!a.pin && b.pin) return 1;

        if (a.key < b.key) return -1;
        if (a.key > b.key) return 1;

        return 0;
      }

      function StateListItem({ item, toggleFn }) {
        return c(
          "li",
          { className: "d-flex justify-content-between list-group-item" },
          c(
            "div",
            { className: "d-flex" },
            c(
              "div",
              { className: "me-2 pin-icon", onClick: () => toggleFn(item.key) },
              item.pin ? "⚫" : "⚪",
            ),
            c("div", { className: "me-2" }, item.key),
          ),
          c("div", null, item.value),
        );
      }

      function StateList({ items, toggleFn }) {
        return c(
          "ul",
          { className: "list-group list-group-flush" },
          items.map((item) => c(StateListItem, { item, toggleFn })),
        );
      }

      function App() {
        const [state, setState] = useState({});
        const [pinned, setPinned] = useState([]);

        function getState() {
          fetch("/api/state/")
            .then((response) => response.json())
            .then((json) => setState(json));
        }

        function getPinned() {
          const pinned = JSON.parse(localStorage.getItem("pinned") || "[]");
          setPinned(pinned);
        }

        function togglePinned(key) {
          const pinnedCopy = [...pinned];

          const idx = pinnedCopy.indexOf(key);
          idx === -1 ? pinnedCopy.push(key) : pinnedCopy.splice(idx, 1);

          setPinned(pinnedCopy);
          localStorage.setItem("pinned", JSON.stringify(pinnedCopy));
        }

        function mergeData() {
          return Object.entries(state)
            .map(([key, value]) => ({
              key,
              value,
              pin: pinned.includes(key),
            }))
            .sort(sortByPinned);
        }

        useEffect(getPinned, []);
        useEffect(getState, []);

        return c(StateList, { items: mergeData(), toggleFn: togglePinned });
      }

      ReactDOM.render(c(App), document.getElementById("root"));
    </script>
  </body>
</html>
